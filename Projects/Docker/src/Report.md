# Simple Docker

Введение в докер. Разработка простого докер-образа для собственного сервера.


## Содержание

[Part 1. Готовый докер](#part-1-готовый-докер) \
[Part 2. Операции с контейнером](#part-2-операции-с-контейнером) \
[Part 3. Мини веб-сервер](#part-3-мини-веб-сервер) \
[Part 4. Свой докер](#part-4-свой-докер) \
[Part 5. Dockle](#part-5-dockle) \
[Part 6. Базовый Docker Compose](#part-6-базовый-docker-compose)



## Part 1. Готовый докер

- Возьми официальный докер-образ с nginx и выкачай его при помощи docker pull.

![docker pull](scrins/Part_1/img-2024-04-24-11-46-19.png)<br>*Получаем образ*<br>

- Проверь наличие докер-образа через docker images.

![docker images](scrins/Part_1/images.png)<br>*обзар скачался, через команду видим результат*<br>

- Запусти докер-образ через `docker run -d [image_id|repository]`.

![docker run](scrins/Part_1/docker_ps.png)<br>*Запускаем контейнер*<br>

- Проверь, что образ запустился через docker ps.

![docker ps](scrins/Part_1/docker_ps_80.png)<br>*Посмотрим список всех запущенных контейнеров*<br>

- Посмотри информацию о контейнере через `docker inspect [container_id|container_name]`.

![docker inspect](scrins/Part_1/docker_inspect.png)<br>*Этой командой смотрим все доступные данные по контейнеру*<br>

- По выводу команды определи и помести в отчёт размер контейнера, список замапленных портов и ip контейнера.

![ip conteiner](scrins/Part_1/inspect_IP.png)<br>*Айпи запущенного контейнера*<br>

![port conteiner](scrins/Part_1/inspect_port.png)<br>*Видим порты*<br>

![size conteiner](scrins/Part_1/inspect_size.png)<br>*Размер запущенного контейнера*<br>

- Останови докер образ через `docker stop [container_id|container_name]`.

- Проверь, что образ остановился через `docker ps -a`.

>Видим через команду что контейнер был остановлен 11 секунд назад и запущенных контейнеров нет

![docker stop](scrins/Part_1/docker_stop.png)<br>*Останавливаем контейнер и посмотрим в каком статусе находяться контейнеры*<br>

- Запусти докер с портами 80 и 443 в контейнере, замапленными на такие же порты на локальной машине, через команду run.

![doker run -p 80 -p 443](scrins/Part_1/run_80_bginx.png)<br>*запускаем контейнер и открываем ему порты*<br>

- Проверь, что в браузере по адресу localhost:80 доступна стартовая страница nginx.

![localhost80](scrins/Part_1/localhost.png)<br>*в контейнере nginx уже работает поэтому можем ввести в браузере локалхост 80*<br>

- Перезапусти докер контейнер через docker restart [container_id|container_name].

![docker restart](scrins/Part_1/restart_80.png)<br>*Перезапускаем контейнер и проверяем работающие контейнеры*<br>

![localhost80](scrins/Part_1/localhost.png)<br>*перезапустив контейнер также можно проверить что страничка nginx  также работает*<br>


[Вернуться к содержанию](#содержание)

## Part 2. Операции с контейнером


- Прочитай конфигурационный файл *nginx.conf* внутри докер контейнера через команду *exec*.

![alt text](scrins/Part_2/1_cat_conf.png)<br>*Читаем файл*<br>

- Создай на локальной машине файл *nginx.conf*.

![alt text](scrins/Part_2/2_»ÑαÑ¡«ß.png)<br>*Копируем данные из терминала в файл к себе на машину*<br>

![alt text](scrins/Part_2/3_reload.png)<br>*Копируем файл в докер*<br>

- Настрой в нем по пути */status* отдачу страницы статуса сервера **nginx**.
- Скопируй созданный файл *nginx.conf* внутрь докер-образа через команду `docker cp`.

![alt text](scrins/Part_2/4_conf.png)

- Перезапусти **nginx** внутри докер-образа через команду *exec*.

![alt text](scrins/Part_2/4_1_restart.png)<br>*копируем файл и перезапускаем службу<br>

- Проверь, что по адресу *localhost:80/status* отдается страничка со статусом сервера **nginx**.

![alt text](scrins/Part_2/5_localhost_status.png)<br>*страничка запускаеться*<br>

- Экспортируй контейнер в файл *container.tar* через команду *export*.
- Останови контейнер.

![alt text](scrins/Part_2/6_export.png)<br>*экспортируем контейнер и останавливаем его*<br>


- Удали образ через `docker rmi [image_id|repository]`, не удаляя перед этим контейнеры.

![alt text](scrins/Part_2/7_rmi_nginx.png)<br>*Принудительно удаляем образ*<br>

![alt text](scrins/Part_2/8_rm_part1_nginx.png)

- Удали остановленный контейнер.
- Импортируй контейнер обратно через команду *import*.

* Даю указание полученному образу собраться с выключенным демоном иначе сборка завершиться некоректно<br>
`sudo docker import -c 'cmd ["nginx", "-g", "daemon off;"]' ./container.tar part1_to_pa
rt2:latest`


- Запусти импортированный контейнер.

![alt text](scrins/Part_2/11_impor_curl.jpg)<br>*Импортирую контейнер запускаю его смотрю вывод локалхост статус*<br>

![alt text](scrins/Part_2/10_images.png)<br>*контейнер запущен*<br>

- Проверь, что по адресу *localhost:80/status* отдается страничка со статусом сервера **nginx**.

![alt text](scrins/Part_2/5_localhost_status.png)<br>*СТраничка запускаеться*<br>

[Вернуться к содержанию](#содержание)


## Part 3. Мини веб-сервер

`sudo apt-get update -y`

`sudo apt-get install -y libfcgi-dev`

`sudo apt install spawn-fcgi`


- Напиши мини-сервер на C и FastCgi, который будет возвращать простейшую страничку с надписью Hello World!.

![пишем страничку](scrins/Part_3/1_hellow.png)<br>*пишем страничку*<br>

![Компилируем](scrins/Part_3/компиляция.png)<br>*Компилируем*<br>

- Запусти написанный мини-сервер через spawn-fcgi на порту 8080.
- Напиши свой nginx.conf, который будет проксировать все запросы с 81 порта на 127.0.0.1:8080.

![nginx.conf](scrins/Part_3/3_nginx.conf.png)<br>*прописываем порты в конфиг*<br>

![обновляем конфиг nginx  и запускаем спавн](scrins/Part_3/2_spawn_fcgi.png)<br>*перезапускаем nginx и запускаем спавн*<br>

- Проверь, что в браузере по localhost:81 отдается написанная тобой страничка.

![alt text](scrins/Part_3/4_localhost80.png)<br>*открываем в браузере нашу страничку*<br>

- Положи файл nginx.conf по пути ./nginx/nginx.conf (это понадобится позже).

[Вернуться к содержанию](#содержание)

## Part 4. Свой докер

`sudo docker build -t sea:part4 .`

`sudo docker run --name sea -ti -p 80:81 sea:part4`

- Напиши свой докер-образ, который:
##### 1) собирает исходники мини сервера на FastCgi из [Части 3](#part-3-мини-веб-сервер);
##### 2) запускает его на 8080 порту;
##### 3) копирует внутрь образа написанный *./nginx/nginx.conf*;
##### 4) запускает **nginx**.

![Dockerfile](<scrins/Part_4/1_Dokerfile.png>)<br>*Пропишем докер файл*<br>

- Собери написанный докер-образ через `docker build` при этом указав имя и тег.

![build](<scrins/Part_4/11m_build_image.png>)<br>*Собираем образ*<br>

- Проверь через `docker images`, что все собралось корректно.

![ps](<scrins/Part_4/restart_ps_conteiner.png>)<br>*Образ собрался*<br>

- Запусти собранный докер-образ с маппингом 81 порта на 80 на локальной машине и маппингом папки *./nginx* внутрь контейнера по адресу, где лежат конфигурационные файлы **nginx**'а (см. [Часть 2](#part-2-операции-с-контейнером)).

![alt text](<scrins/Part_4/run_sea_8081.png>)<br>*Запускаем, с мапингом портов и папки<br>

- Проверь, что по localhost:80 доступна страничка написанного мини сервера.

![local80](<scrins/Part_4/local80.png>)<br>*Пишем в браузер локал хост*<br>

- Допиши в *./nginx/nginx.conf* проксирование странички */status*, по которой надо отдавать статус сервера **nginx**.

![nginx.conf](<scrins/Part_4/nginx.jpg>)<br>*Допишем статус сервера*<br>

- Перезапусти докер-образ.

![Рестарт](<scrins/Part_4/restart_conteiner.png>)<br>*Перезапустим контейнер*<br>

*Если всё сделано верно, то, после сохранения файла и перезапуска контейнера, конфигурационный файл внутри докер-образа должен обновиться самостоятельно без лишних действий*
- Проверь, что теперь по *localhost:80/status* отдается страничка со статусом **nginx**

![status](<scrins/Part_4/localhost_status.png>)<br>*Пишем в браузер локал хост статус*<br>

[Вернуться к содержанию](#содержание)

## Part 5. **Dockle**

- Просканируй образ из предыдущего задания через `dockle [image_id|repository]`.

![dickle](<scrins/Part_5/1_dockle.png>)<br>*Проверим образ части 4й*<br>

- Исправь образ так, чтобы при проверке через **dockle** не было ошибок и предупреждений.

* Нужно исправить две базовые ошибки со статусом **FATAL** и  **WARN**

![dockerfile](<scrins/Part_5/new_Dockerfile.jpg>)<br>*Исправим докер файл*<br>

* Основная ошибка содержиться в Докерфайле по скольку при создании образа все папки создаются от рута то доступа к ним будучи пользователем у меня нет я даже не могу посмотреть сожержимое некоторых папок.
* Что интересно пользователь уже имееться nginx, тоесть мне нужно будучи под рутом дать доступ юзеру nginx к ключевым папкам которые позволяют запускать сервер и остальные файлы которые я закинул через докер файл, и если я зайду под пользователем и запущу `spawn-fcgi -p 8080 ./hello_w` страничка заработет.
* Я укажу пользователя nginx  проведу основые манипуляции от его имени и WARN пропадет.

* Фатальная ошибка завязана на безопасность сервера nginx и безопасной передачи данных, если я рабатаю на стационарной машине то все ключи у меня обновлены и не требует какого либо вмешательства, например я мог бы настроить время жизни нынешнего ключа например месяц и по истечению этого времени вручную его обновить, тем самым отрезав доступ злоумышленику получившим мой GPGKEY.
* Но в образе этого не происходит, поэтому можно показать dockle  что ключ не нуждаеться в обновлении:

`sudo dockle -ak NGINX_GPGKEY -ak NGINX_GPGKEY_PATH sea:part5`

![build](<scrins/Part_5/3_build_images.png>)<br>*Пересобираю образ*<br>

![dockle](<scrins/Part_5/5_dockle.png>)<br>*Ошибок нет*<br>

[Вернуться к содержанию](#содержание)

## Part 6. Базовый **Docker Compose**


>Docker-compose — это надстройка над Docker, приложение на Python, которое позволяет запускать множество контейнеров одновременно и маршрутизировать потоки данных между ними.

- Напиши файл *docker-compose.yml*

* Записывая в ямлфайл название контейнера и образ с которым собираемся работать я посути написал докер файл
в котором сказал создай контейнер с именем "океан" на образе "nginx", открой порты и скопируй конфиг в этот контейнер

![yaml](scrins/Part_6/compose_yam.png)<br>*Запишем ямл файл*<br>

- Замапь 8080 порт второго контейнера на 80 порт локальной машины.

![ocean](scrins/Part_6/ocean_conf.png)<br>*nginx  для второго контейнера с именем ocean*<br>

- Останови все запущенные контейнеры.
- Собери и запусти проект с помощью команд `docker-compose build` и `docker-compose up`.

![compose build](scrins/Part_6/doc_6_compose_build.png)<br>*билдим компос*<br>

![compose up](scrins/Part_6/doc_6_compose_up.png)<br>*запускаем*<br>

![images ps](scrins/Part_6/doc_6_2_image_psa.png)<br>*смотрим что образы и контейнеры созданы*<br>

- Проверь, что в браузере по *localhost:80* отдается написанная тобой страничка, как и ранее.

![localhost](scrins/Part_6/doc_6_3_localhost.png)<br>*сервер на запрос отвечает*<br>

[Вернуться к содержанию](#содержание)